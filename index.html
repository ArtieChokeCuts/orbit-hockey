<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORBIT HOCKEY | TACTILE HD</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        /* touch-action: none and user-select: none completely kill browser input lag */
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Orbitron', sans-serif; user-select: none; touch-action: none; -webkit-user-select: none; }
        canvas { touch-action: none; }
        
        #ui {
            position: absolute; top: 40px; left: 40px;
            color: #fff; pointer-events: none; z-index: 10; display: none;
            background: rgba(0, 20, 40, 0.4); padding: 15px 30px; border-left: 4px solid #00ffff;
            backdrop-filter: blur(10px); text-transform: uppercase;
        }
        .score-row { font-size: 32px; font-weight: 900; letter-spacing: 4px; text-shadow: 0 0 10px #00ffff; }
        .alt-row { font-size: 14px; color: #00ffff; margin-top: 5px; letter-spacing: 2px; }
        
        #penalty-warning { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff0055; font-size: 40px; font-weight: 900; display: none;
            text-shadow: 0 0 20px #ff0055; z-index: 20; letter-spacing: 5px;
            background: rgba(20, 0, 0, 0.8); padding: 20px 40px; border: 2px solid #ff0055;
            pointer-events: none;
        }

        #flash {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #fff; opacity: 0; pointer-events: none; z-index: 50;
            mix-blend-mode: overlay;
        }

        #start-screen, #game-over {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle at center, #001122 0%, #000000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: #00ffff; text-align: center;
        }
        #game-over { display: none; background: rgba(0, 5, 10, 0.9); backdrop-filter: blur(5px); cursor: pointer; }
        h1 { font-size: 60px; margin: 0; letter-spacing: 10px; text-shadow: 0 0 20px #00ffff; text-transform: uppercase; }
        p { font-size: 18px; color: #aaa; letter-spacing: 3px; margin-bottom: 40px; text-transform: uppercase;}
        
        .action-btn {
            background: transparent; color: #00ffff; border: 2px solid #00ffff;
            padding: 15px 40px; font-size: 20px; font-family: 'Orbitron', sans-serif;
            cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 3px;
        }
        .action-btn:hover { background: #00ffff; color: #000; box-shadow: 0 0 30px #00ffff; }
        .blink { animation: blinker 1.5s linear infinite; color: #fff; font-size: 20px; margin-top: 20px; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

<div id="flash"></div>

<div id="start-screen">
    <h1>ORBIT HOCKEY</h1>
    <p>TACTILE ASCENT ENGINE // FIRST TO 10</p>
    <button id="start-btn" class="action-btn">INITIATE LINK</button>
</div>

<div id="game-over">
    <h1 id="end-title">MATCH CONCLUDED</h1>
    <p id="end-subtitle">SYSTEM OVERRIDE</p>
    <div class="blink">TAP ANYWHERE TO RESTART</div>
</div>

<div id="ui">
    <div class="score-row"><span id="p-score">0</span> <span style="color:#444;">//</span> <span id="c-score" style="color:#ff0055; text-shadow: 0 0 10px #ff0055;">0</span></div>
    <div class="alt-row">ALTITUDE: <span id="alt-val">0</span> MI</div>
</div>
<div id="penalty-warning">STALLING</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/shaders/CopyShader.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
let pScore = 0, cScore = 0, altitude = 0, holdTimer = 0;
const goalLimit = 10;
let isPlaying = false;
let audioCtx;

// --- FULLSCREEN API ---
function goFullScreen() {
    const doc = window.document;
    const docEl = doc.documentElement;
    const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
    if (requestFullScreen && !doc.fullscreenElement) {
        requestFullScreen.call(docEl).catch(err => console.warn("Fullscreen blocked by browser:", err));
    }
}

// --- WEB AUDIO API (MIDI SYNTH) ---
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playMIDI(freq, type, duration, vol = 0.5) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

// --- VISUAL FLASH & TACTILE VIBRATION ---
function triggerImpact(type, color = '#ffffff') {
    const flash = document.getElementById('flash');
    flash.style.transition = 'none';
    flash.style.background = color;
    flash.style.opacity = type === 'goal' ? '0.6' : '0.2';
    setTimeout(() => {
        flash.style.transition = 'opacity 0.3s ease-out';
        flash.style.opacity = '0';
    }, 20);

    if (type === 'wall') {
        playMIDI(150, 'sawtooth', 0.1, 0.3);
        if (navigator.vibrate) navigator.vibrate(20);
    } else if (type === 'mallet') {
        playMIDI(400, 'square', 0.1, 0.5);
        if (navigator.vibrate) navigator.vibrate(40);
    } else if (type === 'goal') {
        playMIDI(800, 'sine', 0.2, 0.7);
        setTimeout(() => playMIDI(1200, 'sine', 0.5, 0.7), 150);
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
    }
}

// --- SCENE SETUP ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 8000);
camera.position.set(0, 22, 22);
camera.lookAt(0, 0, 0);

const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

const renderScene = new THREE.RenderPass(scene, camera);
const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.6, 0.5, 0.85);
bloomPass.threshold = 0.1;
const composer = new THREE.EffectComposer(renderer);
composer.addPass(renderScene);
composer.addPass(bloomPass);

// --- STARS ---
const starCount = 6000;
const starGeo = new THREE.BufferGeometry();
const starPos = new Float32Array(starCount * 3);
const starVel = new Float32Array(starCount); 

for(let i=0; i<starCount; i++) {
    starPos[i*3] = THREE.MathUtils.randFloatSpread(4000); 
    starPos[i*3+1] = THREE.MathUtils.randFloatSpread(4000); 
    starPos[i*3+2] = THREE.MathUtils.randFloatSpread(4000); 
    starVel[i] = 10 + Math.random() * 20; 
}
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 2.0, transparent: true, opacity: 0.8}));
scene.add(stars);

// --- TABLE ---
const tableGroup = new THREE.Group();
const tableMesh = new THREE.Mesh(
    new THREE.BoxGeometry(14, 0.2, 26),
    new THREE.MeshPhysicalMaterial({ color: 0x000000, transparent: true, opacity: 0.05 })
);
tableGroup.add(tableMesh);

const edges = new THREE.EdgesGeometry(new THREE.BoxGeometry(14, 0.2, 26));
tableGroup.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.3 })));

const centerLine = new THREE.Mesh(new THREE.PlaneGeometry(14, 0.05), new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.5 }));
centerLine.rotation.x = -Math.PI / 2;
centerLine.position.y = 0.11;
tableGroup.add(centerLine);
scene.add(tableGroup);

const puck = new THREE.Mesh(
    new THREE.CylinderGeometry(0.5, 0.5, 0.2, 32),
    new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x00ffff, emissiveIntensity: 2 })
);
scene.add(puck);

const player = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.2, 0.4, 32), new THREE.MeshStandardMaterial({color: 0x000000, emissive: 0x00ffff, emissiveIntensity: 0.8, wireframe: true}));
const cpu = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.2, 0.4, 32), new THREE.MeshStandardMaterial({color: 0x000000, emissive: 0xff0055, emissiveIntensity: 0.8, wireframe: true}));
player.position.set(0, 0.3, 10);
cpu.position.set(0, 0.3, -10);
scene.add(player, cpu);

function createGoalLight(z, color) {
    const light = new THREE.PointLight(color, 2, 12);
    light.position.set(0, 0.5, z);
    scene.add(light);
}
createGoalLight(13, 0x00ffff);
createGoalLight(-13, 0xff0055);

// --- HIGH-SPEED INPUT (POINTER EVENTS) ---
let vel = { x: 0, z: 0 };
const mouse = new THREE.Vector2();
const raycaster = new THREE.Raycaster();
const tablePlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), -0.3);
const intersectPoint = new THREE.Vector3();

function handlePointer(e) {
    if(!isPlaying || !e.isPrimary) return;
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    if(raycaster.ray.intersectPlane(tablePlane, intersectPoint)) {
        player.position.x = Math.max(-5.5, Math.min(5.5, intersectPoint.x));
        player.position.z = Math.max(0.6, Math.min(11.5, intersectPoint.z));
    }
}

// Unified Pointer API for zero-latency tracking
window.addEventListener('pointermove', handlePointer);
window.addEventListener('pointerdown', handlePointer);

// --- GAME LOGIC ---
const bgTrack = new Audio('background.mp3');
bgTrack.loop = true; bgTrack.volume = 0.4; 

function announceScore() {
    const msg = new SpeechSynthesisUtterance(`${pScore} to ${cScore}`);
    msg.rate = 0.95; msg.pitch = 0.8;
    window.speechSynthesis.speak(msg);
}

function resetPlay() {
    puck.position.set(0, 0.3, 0);
    vel = { x: (Math.random()-0.5)*0.5, z: (Math.random() > 0.5 ? 0.4 : -0.4) };
    document.getElementById('p-score').innerText = pScore;
    document.getElementById('c-score').innerText = cScore;
}

function endGame() {
    isPlaying = false;
    const isWin = pScore >= goalLimit;
    document.getElementById('ui').style.display = 'none';
    document.getElementById('game-over').style.display = 'flex';
    document.getElementById('end-title').innerText = isWin ? 'ORBIT CONQUERED' : 'SYSTEM OVERRIDE';
    document.getElementById('end-title').style.color = isWin ? '#00ffff' : '#ff0055';
    document.getElementById('end-subtitle').innerText = `${pScore} â€” ${cScore}`;
}

function updatePhysics() {
    puck.position.x += vel.x;
    puck.position.z += vel.z;

    if (Math.abs(puck.position.x) > 6.5) {
        vel.x *= -1;
        puck.position.x = Math.sign(puck.position.x) * 6.5; 
        triggerImpact('wall', '#00ffff');
    }
    
    if (Math.abs(puck.position.z) > 13) {
        if (Math.abs(puck.position.x) < 3.5) {
            puck.position.z > 0 ? cScore++ : pScore++;
            triggerImpact('goal', puck.position.z > 0 ? '#ff0055' : '#00ffff');
            announceScore();
            
            if (pScore >= goalLimit || cScore >= goalLimit) {
                endGame();
                return;
            }
            resetPlay();
        } else { 
            vel.z *= -1; 
            puck.position.z = Math.sign(puck.position.z) * 13;
            triggerImpact('wall', '#00ffff');
        }
    }

    [player, cpu].forEach(m => {
        if (puck.position.distanceTo(m.position) < 1.7) {
            const angle = Math.atan2(puck.position.z - m.position.z, puck.position.x - m.position.x);
            vel.x = Math.cos(angle) * 0.6; 
            vel.z = Math.sin(angle) * 0.6;
            triggerImpact('mallet', m === player ? '#00ffff' : '#ff0055');
        }
    });

    const isStalling = puck.position.distanceTo(player.position) < 2.5 || puck.position.distanceTo(cpu.position) < 2.5;
    if (isStalling && Math.abs(vel.x) < 0.08 && Math.abs(vel.z) < 0.08) {
        holdTimer += 0.016;
        if(holdTimer > 2) document.getElementById('penalty-warning').style.display = 'block';
        if(holdTimer > 3) { resetPlay(); holdTimer = 0; }
    } else {
        holdTimer = 0;
        document.getElementById('penalty-warning').style.display = 'none';
    }

    cpu.position.x += (puck.position.x - cpu.position.x) * (0.09 + pScore * 0.005);
}

function updateVisuals() {
    altitude = (pScore + cScore) * 150;
    document.getElementById('alt-val').innerText = Math.floor(altitude);

    const pos = starGeo.attributes.position.array;
    for(let i=0; i<starCount; i++) {
        pos[i*3+2] += starVel[i] + (altitude * 0.08); 
        if(pos[i*3+2] > 2000) {
            pos[i*3+2] = -3000;
            pos[i*3] = THREE.MathUtils.randFloatSpread(4000); 
            pos[i*3+1] = THREE.MathUtils.randFloatSpread(4000); 
        }
    }
    starGeo.attributes.position.needsUpdate = true;
}

function animate() {
    if (!isPlaying) return;
    requestAnimationFrame(animate);
    updatePhysics();
    updateVisuals();
    composer.render(); 
}

// --- INITIALIZATION ---
document.getElementById('start-btn').addEventListener('click', () => {
    goFullScreen();
    initAudio();
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    
    bgTrack.play().catch(e => console.log(e));
    isPlaying = true;
    resetPlay();
    animate();
});

document.getElementById('game-over').addEventListener('click', () => {
    goFullScreen();
    pScore = 0; cScore = 0; altitude = 0; holdTimer = 0;
    document.getElementById('game-over').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    resetPlay();
    isPlaying = true;
    animate();
});

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    composer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
